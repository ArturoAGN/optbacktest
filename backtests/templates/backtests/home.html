{% extends "base.html" %}
{% block title %}OptBacktest{% endblock %}

{% block content %}
  {% if messages %}
    {% for message in messages %}
      <article role="alert" class="{{ message.tags }}">{{ message }}</article>
    {% endfor %}
  {% endif %}

  <!-- ====== Filtro compacto ====== -->
  <article class="form-card">
    <form method="get">
      <div class="form-row">
        <label><span>Ticker</span>{{ form.ticker }}</label>
        <label><span>Desde</span>{{ form.start_date }}</label>
        <label><span>Hasta</span>{{ form.end_date }}</label>
        <button type="submit" class="btn-compact">Consultar</button>
      </div>
    </form>
  </article>

  {% if chart_10m or chart_30m or chart_1d %}

  <!-- ====== Toolbar de Backtesting + Panel P&L ====== -->
  <article class="bt-toolbar">
    <div class="bt-controls">
      <button id="btnStart" title="Ir al inicio">‚èÆ Inicio</button>
      <button id="btnBack"  title="Retroceder 1 paso">‚è™ -10m</button>
      <button id="btnPlay"  title="Reproducir">‚ñ∂ Play</button>
      <button id="btnPause" title="Pausar" disabled>‚è∏ Pausa</button>
      <button id="btnFwd"   title="Avanzar 1 paso">‚è© +10m</button>
      <button id="btnReset" class="secondary" title="Reset de backtest (borra posiciones/√≥rdenes/equity)">üîÅ Reset</button>

      <label style="margin-left:.5rem;">
        <span class="lbl">Velocidad</span>
        <select id="speed">
          <option value="0.5">0.5√ó</option>
          <option value="1" selected>1√ó</option>
          <option value="2">2√ó</option>
          <option value="4">4√ó</option>
        </select>
      </label>
    </div>

    <div class="bt-status">
      <span class="pill">TZ: {{ display_tz_name }}</span>
      <span>t=<strong id="bt-ts">‚Äî</strong></span>
      <span>Subyacente=<strong id="bt-px">‚Äî</strong></span>
      <span>Opci√≥n=<strong id="bt-opt">‚Äî</strong></span>
      <span>P&amp;L=<strong id="bt-pnl" class="">0.00</strong></span>
    </div>
  </article>

  <!-- ====== √ìrdenes r√°pidas + par√°metros de simulaci√≥n ====== -->
  <article class="bt-ops">
    <div>
      <div class="row">
        <label>
          <span>Activo</span>
          <select id="px-source">
            <option value="under">Subyacente</option>
            {% if chart_opt %}<option value="option">Opci√≥n</option>{% endif %}
          </select>
        </label>
        <label>
          <span>Cantidad</span>
          <input type="number" id="qty" value="0" step="1" min="-999" max="999" style="width:100px;">
        </label>
        <button id="btnBuy">Comprar (Market)</button>
        <button id="btnSell">Vender (Market)</button>
        <button id="btnFlat" class="secondary">Cerrar</button>
      </div>
      <small class="muted">Nota: para opciones se usa multiplicador 100 por contrato.</small>
    </div>

    <div class="ops-right">
      <div>Posici√≥n: <strong id="pos-side">Flat</strong> | Qty: <strong id="pos-qty">0</strong> | Entrada: <strong id="pos-entry">‚Äî</strong></div>
      <div>MTM actual: <strong id="pos-mtm">0.00</strong></div>
      <div class="row" style="margin-top:.35rem;">
        <label><span>Slippage (bps)</span><input id="slip-bps" type="number" value="0" step="1" min="0" style="width:100px;"></label>
        <label><span>Comisi√≥n fija (por orden)</span><input id="comm-fixed" type="number" value="0" step="0.01" min="0" style="width:130px;"></label>
        <label><span>Comisi√≥n por unidad</span><input id="comm-perunit" type="number" value="0" step="0.01" min="0" style="width:130px;"></label>
        <label><span>Capital inicial</span><input id="initial-capital" type="number" value="100000" step="100" min="0" style="width:140px;"></label>
      </div>
    </div>
  </article>

  <!-- ====== Toggle del Panel 4 (Opci√≥n / Equity) ====== -->
  <article class="panel4-toggle">
    <div class="row">
      <strong>Panel 4:</strong>
      <label class="radio-inline"><input type="radio" name="panel4mode" value="OPTION"> Opci√≥n</label>
      <label class="radio-inline"><input type="radio" name="panel4mode" value="EQUITY"> Equity</label>
      <span class="muted">Puedes alternar entre el gr√°fico de la opci√≥n seleccionada y la curva de capital (equity curve + drawdown).</span>
    </div>
  </article>

  <!-- ====== Gr√°ficos + Cadena ====== -->
  <article class="layout">
    <!-- Izquierda: 4 gr√°ficos (el 4¬∫ se usa para Opci√≥n o Equity) -->
    <div>
      <div class="grid-2">
        <section class="panel"><div id="chart_10m" class="chart"></div></section>
        <section class="panel"><div id="chart_30m" class="chart"></div></section>
        <section class="panel"><div id="chart_1d" class="chart"></div></section>
        <section class="panel"><div id="chart_opt" class="chart"></div></section>
      </div>
    </div>

    <!-- Derecha: Cadena con scroll -->
    <aside class="chain-container">
      <div class="chain-header">
        Cadena de opciones <span class="muted">as of {{ form.cleaned_data.start_date|date:"Y-m-d" }}</span>
      </div>
      <div class="chain-body">
        {% if option_chain %}
          <table>
            <thead>
              <tr><th>Ticker</th><th>Tipo</th><th>Strike</th><th>Venc.</th><th>DTE</th><th>Acci√≥n</th></tr>
            </thead>
            <tbody>
            {% for c in option_chain %}
              <tr>
                <td><code>{{ c.ticker }}</code></td>
                <td style="text-transform:uppercase;">{{ c.contract_type }}</td>
                <td>{{ c.strike_price }}</td>
                <td>{{ c.expiration_date }}</td>
                <td>{{ c.dte }}</td>
                <td>
                  <form method="get" style="display:inline;">
                    <input type="hidden" name="ticker" value="{{ form.cleaned_data.ticker }}">
                    <input type="hidden" name="start_date" value="{{ form.cleaned_data.start_date|date:'Y-m-d' }}">
                    <input type="hidden" name="end_date" value="{{ form.cleaned_data.end_date|date:'Y-m-d' }}">
                    <input type="hidden" name="opt" value="{{ c.ticker }}">
                    <button type="submit" class="btn-compact-table">Graficar</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted">No hay contratos disponibles en el rango seleccionado.</p>
        {% endif %}
      </div>
    </aside>
  </article>

  <!-- ====== √ìrdenes abiertas ====== -->
  <article class="section-card">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem;">
      <strong>√ìrdenes</strong>
      <div>
        <button id="btnExportOrders" class="secondary">Exportar √≥rdenes CSV</button>
      </div>
    </header>
    <div class="table-wrap">
      <table>
        <thead>
        <tr>
          <th>ID</th><th>TS</th><th>Side</th><th>Tipo</th><th>Precio</th><th>Qty</th><th>Activo</th><th>Estado</th><th>Fill TS</th><th>Fill Px</th><th>Acci√≥n</th>
        </tr>
        </thead>
        <tbody id="orders-body"></tbody>
      </table>
    </div>
  </article>

  <!-- ====== Trades cerrados ====== -->
  <article class="section-card">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem;">
      <strong>Trades</strong>
      <div>
        <button id="btnExportTrades" class="secondary">Exportar trades CSV</button>
      </div>
    </header>
    <div class="table-wrap">
      <table>
        <thead>
        <tr>
          <th>ID</th><th>Side</th><th>Qty</th><th>Entrada TS</th><th>Entrada Px</th><th>Salida TS</th><th>Salida Px</th><th>P&amp;L</th>
        </tr>
        </thead>
        <tbody id="trades-body"></tbody>
      </table>
    </div>
  </article>

  <!-- ====== Contexto JSON para JS ====== -->
  {{ bt_context|json_script:"bt-context" }}

  {% endif %}
{% endblock %}
