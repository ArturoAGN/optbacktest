{% extends "base.html" %}
{% block title %}OptBacktest{% endblock %}

{% block content %}
  {% if messages %}
    {% for message in messages %}
      <article role="alert" class="{{ message.tags }}">{{ message }}</article>
    {% endfor %}
  {% endif %}

  <!-- ====== Filtro compacto ====== -->
  <article class="form-card">
    <form method="get">
      <div class="form-row">
        <label><span>Ticker</span>{{ form.ticker }}</label>
        <label><span>Desde</span>{{ form.start_date }}</label>
        <label><span>Hasta</span>{{ form.end_date }}</label>
        <button type="submit" class="btn-compact">Consultar</button>
      </div>
    </form>
  </article>

  {% if chart_10m or chart_30m or chart_1d %}

  <!-- ====== Toolbar de Backtesting + Panel P&L ====== -->
  <article class="bt-toolbar">
    <div class="bt-controls">
      <button id="btnStart" title="Ir al inicio">⏮ Inicio</button>
      <button id="btnBack"  title="Retroceder 1 paso">⏪ -10m</button>
      <button id="btnPlay"  title="Reproducir">▶ Play</button>
      <button id="btnPause" title="Pausar" disabled>⏸ Pausa</button>
      <button id="btnFwd"   title="Avanzar 1 paso">⏩ +10m</button>
      <label style="margin-left:.5rem;">
        <span class="lbl">Velocidad</span>
        <select id="speed">
          <option value="0.5">0.5×</option>
          <option value="1" selected>1×</option>
          <option value="2">2×</option>
          <option value="4">4×</option>
        </select>
      </label>
    </div>

    <div class="bt-status">
      <span class="pill">TZ: {{ display_tz_name }}</span>
      <span>t=<strong id="bt-ts">—</strong></span>
      <span>Subyacente=<strong id="bt-px">—</strong></span>
      <span>Opción=<strong id="bt-opt">—</strong></span>
      <span>P&amp;L=<strong id="bt-pnl" class="">0.00</strong></span>
    </div>
  </article>

  <article class="bt-ops">
    <div>
      <div class="row">
        <label>
          <span>Activo</span>
          <select id="px-source">
            <option value="under">Subyacente</option>
            {% if chart_opt %}<option value="option">Opción</option>{% endif %}
          </select>
        </label>
        <label>
          <span>Cantidad</span>
          <input type="number" id="qty" value="0" step="1" min="-999" max="999" style="width:100px;">
        </label>
        <button id="btnBuy">Comprar</button>
        <button id="btnSell">Vender</button>
        <button id="btnFlat" class="secondary">Cerrar</button>
      </div>
      <small class="muted">Nota: para opciones se usa multiplicador 100 por contrato.</small>
    </div>
    <div class="ops-right">
      <div>Posición: <strong id="pos-side">Flat</strong> | Qty: <strong id="pos-qty">0</strong> | Entrada: <strong id="pos-entry">—</strong></div>
      <div>MTM actual: <strong id="pos-mtm">0.00</strong></div>
    </div>
  </article>

  <!-- ====== Gráficos: rejilla 2x2 + cadena a la derecha ====== -->
  <article class="layout">
    <!-- Izquierda: 4 gráficos (el último reservado para opción) -->
    <div>
      <div class="grid-2">
        <section class="panel"><div id="chart_10m" class="chart"></div></section>
        <section class="panel"><div id="chart_30m" class="chart"></div></section>
        <section class="panel"><div id="chart_1d" class="chart"></div></section>
        {% if chart_opt %}
          <section class="panel"><div id="chart_opt" class="chart"></div></section>
        {% else %}
          <section class="panel placeholder"><div>Espacio para gráficos de opciones</div></section>
        {% endif %}
      </div>
    </div>

    <!-- Derecha: Cadena con scroll -->
    <aside class="chain-container">
      <div class="chain-header">
        Cadena de opciones <span class="muted">as of {{ form.cleaned_data.start_date|date:"Y-m-d" }}</span>
      </div>
      <div class="chain-body">
        {% if option_chain %}
          <table>
            <thead>
              <tr><th>Ticker</th><th>Tipo</th><th>Strike</th><th>Venc.</th><th>DTE</th><th>Acción</th></tr>
            </thead>
            <tbody>
            {% for c in option_chain %}
              <tr>
                <td><code>{{ c.ticker }}</code></td>
                <td style="text-transform:uppercase;">{{ c.contract_type }}</td>
                <td>{{ c.strike_price }}</td>
                <td>{{ c.expiration_date }}</td>
                <td>{{ c.dte }}</td>
                <td>
                  <form method="get" style="display:inline;">
                    <input type="hidden" name="ticker" value="{{ form.cleaned_data.ticker }}">
                    <input type="hidden" name="start_date" value="{{ form.cleaned_data.start_date|date:'Y-m-d' }}">
                    <input type="hidden" name="end_date" value="{{ form.cleaned_data.end_date|date:'Y-m-d' }}">
                    <input type="hidden" name="opt" value="{{ c.ticker }}">
                    <button type="submit" class="btn-compact-table">Graficar</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted">No hay contratos disponibles en el rango seleccionado.</p>
        {% endif %}
      </div>
    </aside>
  </article>

  <!-- ====== Contexto JSON para JS (modular) ====== -->
  {{ bt_context|json_script:"bt-context" }}

  {% endif %}
{% endblock %}
